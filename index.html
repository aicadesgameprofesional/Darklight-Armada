<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Neon Ship Fury — Drone + Online 2–4 jugadores + Ranking + Ubicación real</title>
<style>
  :root{
    --bg:#03040a;
    --glass:rgba(10,12,24,0.68);
    --line:rgba(255,255,255,0.10);
    --text:#eaf3ff;
    --muted:#9fb0ce;
    --neon1:#2df7ff;
    --neon2:#ff3a8c;
    --neon3:#7bff7b;
    --accent:#ffd166;
    --danger:#ff5544;
    --ok:#55ff88;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  .screen{opacity:0; transform:scale(0.98); filter:blur(4px); transition:opacity .28s, transform .28s, filter .28s}
  .screen.show{opacity:1; transform:scale(1); filter:blur(0)}
  .fade-out{ animation:fadeOut .24s ease forwards }
  @keyframes fadeOut{ to{opacity:0; transform:scale(0.98); filter:blur(4px)} }

  /* Splash */
  #splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:radial-gradient(1200px 500px at 50% 50%, #0a0e2a 0%, #000 60%); z-index:9999;}
  .logo{
    font-weight:900; letter-spacing:.16em; font-size:44px; text-transform:uppercase;
    background:conic-gradient(from 0deg, var(--neon1), var(--neon2), var(--neon3));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 0 18px rgba(45,247,255,.25), 0 0 24px rgba(255,58,140,.18);
    opacity:0; transform:translateY(18px) scale(.98); animation:logoIn 1.1s ease forwards .2s;
  }
  .rights{margin-top:10px; font-size:13px; color:var(--muted); opacity:0; transform:translateY(10px); animation:fadeUp .9s ease forwards .7s}
  .beam{position:absolute; left:50%; top:0; transform:translateX(-50%); width:2px; height:0; background:linear-gradient(180deg, rgba(45,247,255,0), rgba(255,58,140,.6)); box-shadow:0 0 22px rgba(255,58,140,.25); animation:beamDrop 1.2s cubic-bezier(.2,.8,.2,1) .55s forwards}
  @keyframes logoIn{to{opacity:1; transform:translateY(0) scale(1)}}
  @keyframes fadeUp{to{opacity:.92; transform:translateY(0)}}
  @keyframes beamDrop{to{height:74%}}

  /* Menú épico */
  #menu{position:fixed; inset:0; display:none; overflow:hidden; background:#000;}
  #spaceBG{position:absolute; inset:0; z-index:0;}
  .battle-waves{ position:absolute; inset:0; pointer-events:none; z-index:0; mix-blend-mode:screen }
  .battle-waves::before, .battle-waves::after{
    content:''; position:absolute; inset:0;
    background:radial-gradient(600px 300px at 20% 80%, rgba(45,247,255,.08), transparent 60%),
                radial-gradient(520px 240px at 82% 20%, rgba(255,58,140,.08), transparent 60%),
                radial-gradient(360px 220px at 50% 50%, rgba(123,255,123,.06), transparent 60%);
    animation:wavePulse 8s ease-in-out infinite;
  }
  @keyframes wavePulse{ 0%,100%{filter:hue-rotate(0)} 50%{filter:hue-rotate(40deg)} }

  .menu-wrap{ position:relative; z-index:2; max-width:1200px; margin:0 auto; padding:18px; height:100%;
    display:grid; grid-template-columns:1.1fr .9fr; gap:16px; }
  .panel{
    background:var(--glass); backdrop-filter:blur(12px);
    border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,.35);
    display:flex; flex-direction:column; max-height:calc(100vh - 36px); overflow:auto;
    animation:panelIn .5s ease forwards;
  }
  @keyframes panelIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
  .title{ font-weight:900; letter-spacing:.16em; color:#eaf3ff; text-transform:uppercase; margin:0 0 8px 0; font-size:24px;
    text-shadow:0 0 10px rgba(45,247,255,.35), 0 0 18px rgba(255,58,140,.25) }
  .subtitle{ color:var(--muted); font-weight:700; letter-spacing:.08em; font-size:13px }

  .arcade-buttons{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    color:#eaf3ff; background:linear-gradient(180deg, #0d1030, #080a24);
    border:2px solid transparent; border-image:linear-gradient(90deg, var(--neon1), var(--neon2), var(--neon3)) 1;
    border-radius:14px; padding:12px; cursor:pointer;
    transition:transform .14s, box-shadow .14s, filter .14s;
    font-weight:900; text-transform:uppercase; letter-spacing:.1em; font-size:14px;
    box-shadow:0 0 12px rgba(45,247,255,.22), 0 0 18px rgba(255,58,140,.18);
  }
  .btn:hover{ transform:translateY(-2px) scale(1.02); filter:brightness(1.12);
    box-shadow:0 0 20px rgba(45,247,255,.38), 0 0 24px rgba(255,58,140,.28) }

  .list{display:flex; flex-direction:column; gap:8px}
  .stat{display:flex; align-items:center; justify-content:space-between; border-bottom:1px dashed var(--line); padding:6px 0; font-size:13px}

  /* Modales */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000; background:rgba(0,0,0,.6); padding:16px }
  .modal .panel{ max-width:900px; width:100%; height:auto; max-height:calc(100vh - 48px); margin:0 auto }

  /* Etiquetas online */
  .name-tag{
    position:absolute; font-size:10px; font-weight:700; letter-spacing:.06em; text-transform:uppercase;
    padding:2px 6px; border-radius:8px; background:rgba(12,14,28,.75); border:1px solid rgba(255,255,255,.14);
    color:#eaf3ff; pointer-events:none; z-index:9; white-space:nowrap; transform:translate(-50%, -140%);
    box-shadow:0 0 12px rgba(45,247,255,.18), 0 0 18px rgba(255,58,140,.12);
  }

  table{width:100%; border-collapse:collapse}
  th,td{border-bottom:1px dashed var(--line); padding:8px; font-size:13px; text-align:left}

  /* Juego */
  #game{ position:fixed; inset:0; display:none; background:radial-gradient(900px 420px at 50% 50%, #0a0d26 0%, #000 62%) }
  #canvas{ position:absolute; inset:0 }
  #hud{ position:absolute; top:8px; left:8px; right:8px; display:flex; gap:8px; align-items:flex-start; z-index:3; flex-wrap:wrap; justify-content:center }
  .hud-card{ background:rgba(12,14,28,.72); backdrop-filter:blur(7px); border:1px solid var(--line); border-radius:10px; padding:8px 10px; color:#eaf3ff; min-width:220px }
  .hud-row{display:flex; gap:8px; flex-wrap:wrap}
  .hud-stat{ display:flex; align-items:center; gap:6px }
  .hud-ico{ width:16px; height:16px }

  /* Jefe */
  #bossBarWrap{ position:absolute; top:8px; left:50%; transform:translateX(-50%); width:min(560px, 92%); height:18px; z-index:4; display:none; align-items:center; gap:8px }
  #bossBar{ flex:1; height:12px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden; border:1px solid var(--line) }
  #bossBarFill{ height:100%; width:0%; background:linear-gradient(90deg, #ff6f3a, var(--accent)); box-shadow:0 0 12px rgba(255,111,58,.45) }
  #bossName{ color:var(--accent); font-weight:800; letter-spacing:.08em; text-transform:uppercase; font-size:12px }

  /* Banners */
  #levelBanner,#comboBanner{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(.9);
    color:#fff; font-weight:900; letter-spacing:.12em; text-transform:uppercase;
    padding:12px 16px; border-radius:999px; background:linear-gradient(90deg, rgba(45,247,255,.18), rgba(255,58,140,.18));
    border:1px solid rgba(255,255,255,.15); backdrop-filter:blur(8px); opacity:0; z-index:5; pointer-events:none; font-size:14px
  }
  .level-in{ animation:levelIn .9s ease-out forwards }
  .combo-in{ animation:comboIn .8s ease-out forwards }
  @keyframes levelIn{ 0%{opacity:0; transform:translate(-50%,-50%) scale(.9)} 20%{opacity:1; transform:translate(-50%,-50%) scale(1)} 100%{opacity:0; transform:translate(-50%,-50%) scale(1.06)} }
  @keyframes comboIn{ 0%{opacity:0; transform:translate(-50%,-50%) scale(.8) rotate(-5deg)} 20%{opacity:1; transform:translate(-50%,-50%) scale(1)} 100%{opacity:0} }

  /* Overlays centrados */
  #pauseOverlay,#gameOverOverlay,#waitingOnline{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:8; padding:16px
  }
  .overlay-panel{ background:var(--glass); backdrop-filter:blur(12px); border:1px solid var(--line); border-radius:16px; padding:16px; width:95%; max-width:520px; box-shadow:0 8px 30px rgba(0,0,0,.35); }
  .go-stats{ display:flex; flex-direction:column; gap:8px; color:#eaf3ff }
  .go-title{ font-weight:900; letter-spacing:.12em; text-transform:uppercase; font-size:20px }

  .toggle{ display:inline-flex; align-items:center; gap:8px; background:rgba(14,16,28,.5); border:1px solid var(--line); border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none; font-size:12px }
  .toggle-dot{width:14px; height:14px; border-radius:50%; background:#ff6677}
  .toggle.on .toggle-dot{ background:#55ff88 }

  @media (max-width:900px){
    .menu-wrap{grid-template-columns:1fr}
    .arcade-buttons{grid-template-columns:1fr 1fr}
    .title{font-size:22px}
  }
  @media (max-width:520px){
    .arcade-buttons{grid-template-columns:1fr}
    .hud-card{min-width:auto}
    .btn{font-size:13px; padding:10px}
    .title{font-size:20px}
  }
</style>
</head>
<body>

<section id="splash">
  <div class="beam"></div>
  <div class="logo">Aicade Games</div>
  <div class="rights">Todos los derechos reservados © 2026</div>
</section>

<section id="menu" class="screen">
  <canvas id="spaceBG"></canvas>
  <div class="battle-waves"></div>
  <div class="menu-wrap">
    <div class="panel">
      <h2 class="title">Neon Ship Fury</h2>
      <div class="subtitle">Arcade neon con drone real y batalla online</div>

      <div class="arcade-buttons">
        <button class="btn" id="btnPlay">Jugar (normal)</button>
        <button class="btn" id="btnPlayOnline">Jugar online (2–4)</button>
        <button class="btn" id="btnRanking">Ver ranking</button>
        <button class="btn" id="btnProfile">Perfil</button>
        <button class="btn" id="btnHistory">Historial</button>
        <button class="btn" id="btnQuit">Salir</button>
      </div>

      <div class="list" style="margin-top:10px">
        <div class="stat"><span>PC</span><span>WASD/Flechas, Espacio dispara, P pausa</span></div>
        <div class="stat"><span>Sonidos</span><span><span id="soundToggle" class="toggle"><span class="toggle-dot"></span><span>Sonido</span></span></span></div>
        <div class="stat"><span>Cuenta</span><span id="accountReq">Sin sesión: online limitado</span></div>
      </div>
    </div>

    <div class="panel">
      <h3 class="title">Estado del jugador</h3>
      <div class="list" id="playerState">
        <div class="stat"><span>Usuario</span><strong id="psUser">—</strong></div>
        <div class="stat"><span>País/IP</span><strong id="psGeo">—</strong></div>
        <div class="stat"><span>Puntos</span><strong id="psPoints">0</strong></div>
        <div class="stat"><span>Nivel</span><strong id="psLevel">1</strong></div>
      </div>
      <div style="margin-top:6px; color:var(--muted)">El online inicia cuando haya mínimo 2 jugadores conectados (máximo 4).</div>
    </div>
  </div>
</section>

<div class="modal screen" id="modalProfile">
  <div class="panel">
    <h3 class="title">Perfil</h3>
    <div class="list">
      <label>Nombre</label>
      <input id="pfUsername" class="btn" style="text-transform:none; letter-spacing:normal; background:rgba(20,24,48,.6)" placeholder="Tu nombre" />
      <label>Correo</label>
      <input id="pfEmail" type="email" class="btn" style="text-transform:none; letter-spacing:normal; background:rgba(20,24,48,.6)" placeholder="email@dominio.com" />
      <label>Contraseña</label>
      <input id="pfPassword" type="password" class="btn" style="text-transform:none; letter-spacing:normal; background:rgba(20,24,48,.6)" placeholder="******" />
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px">
        <button class="btn" id="btnRegister">Registrarse</button>
        <button class="btn" id="btnLogin">Iniciar sesión</button>
        <button class="btn" id="btnLogout">Salir</button>
      </div>
      <div style="border-top:1px dashed var(--line); margin-top:10px; padding-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <button class="btn" id="btnAcceptGeo">Detectar país (pedir ubicación)</button>
        <span id="pfGeoNote" style="color:var(--muted); font-size:12px">El país se guarda al aceptar permisos de ubicación.</span>
      </div>
      <div style="border-top:1px dashed var(--line); margin-top:10px; padding-top:10px">
        <div><strong>Conectado:</strong> <span id="pfConnected">No</span></div>
        <div><strong>UID:</strong> <span id="pfUID">—</span></div>
        <div><strong>País/IP:</strong> <span id="pfGeo">—</span></div>
      </div>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center">
      <button class="btn" data-close="#modalProfile">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal screen" id="modalRanking">
  <div class="panel">
    <h3 class="title">Ranking de jugadores</h3>
    <div class="list" style="max-height:55vh; overflow:auto">
      <table>
        <thead><tr><th>Usuario</th><th>Rango</th><th>Puntos</th><th>País</th></tr></thead>
        <tbody id="rankTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
      <button class="btn" data-close="#modalRanking">Cerrar</button>
    </div>
    <div style="margin-top:6px; color:var(--muted); text-align:center">El ranking muestra puntuaciones más altas.</div>
  </div>
</div>

<div class="modal screen" id="modalHistory">
  <div class="panel">
    <h3 class="title">Historial de partidas</h3>
    <div class="list" style="max-height:55vh; overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Puntos</th><th>Nivel</th><th>Modo</th></tr></thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
      <button class="btn" id="btnResetProgress">Reiniciar progreso (Normal)</button>
      <button class="btn" data-close="#modalHistory">Cerrar</button>
    </div>
  </div>
</div>

<section id="game" class="screen">
  <canvas id="canvas"></canvas>
  <div id="levelBanner"></div>
  <div id="comboBanner"></div>

  <div id="hud">
    <div class="hud-card">
      <div class="hud-stat"><svg class="hud-ico" viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-9a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 4.65-7 9-7 9Z" fill="#ff4d6d"/></svg><strong>Vidas:</strong> <span id="hudLives">3</span></div>
      <div class="hud-stat"><svg class="hud-ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="#ffd166" fill="none"/><path d="M12 7v6l4 2" stroke="#ffd166"/></svg><strong>Nivel:</strong> <span id="hudLevel">1</span></div>
      <div class="hud-stat"><svg class="hud-ico" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18" stroke="#2df7ff"/></svg><strong>Puntos:</strong> <span id="hudScore">0</span></div>
      <div class="hud-stat"><svg class="hud-ico" viewBox="0 0 24 24"><path d="M5 19h14l-2-10H7z" stroke="#7bff7b" fill="none"/></svg><strong>Modo:</strong> <span id="hudMode">Normal</span></div>
    </div>
    <div class="hud-card" style="flex:1">
      <div style="font-weight:700; margin-bottom:6px">Poderes activos</div>
      <div class="hud-row" id="hudPowers"></div>
    </div>
    <div class="hud-card">
      <button class="btn" id="btnPause">Pausar</button>
      <button class="btn" id="btnExitGame">Salir</button>
    </div>
  </div>

  <div id="bossBarWrap">
    <div id="bossName">Jefe</div>
    <div id="bossBar"><div id="bossBarFill"></div></div>
  </div>

  <!-- Pausa -->
  <div id="pauseOverlay" class="screen">
    <div class="overlay-panel">
      <h3 class="title">Pausa</h3>
      <div class="list">
        <div>Combina poderes para neutralizar jefes.</div>
        <div>El fondo cambia según nivel.</div>
      </div>
      <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="btnResume">Reanudar</button>
        <button class="btn" id="btnRestart">Reiniciar</button>
        <button class="btn" id="btnBackMenu">Menú</button>
      </div>
    </div>
  </div>

  <!-- Game Over -->
  <div id="gameOverOverlay" class="screen">
    <div class="overlay-panel">
      <div class="go-stats">
        <div class="go-title">Game Over</div>
        <div><strong>Puntos:</strong> <span id="goPoints">0</span></div>
        <div><strong>Nivel alcanzado:</strong> <span id="goLevel">1</span></div>
        <div><strong>Modo:</strong> <span id="goMode">Normal</span></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn" id="btnGORestart">Reiniciar</button>
        <button class="btn" id="btnGOMenu">Menú</button>
      </div>
    </div>
  </div>

  <!-- Espera online -->
  <div id="waitingOnline" class="screen">
    <div class="overlay-panel" style="text-align:center">
      <h3 class="title">Esperando jugadores</h3>
      <div class="list"><div>Entraste a la sala online.</div><div>La partida comienza cuando haya al menos 2 jugadores (máximo 4).</div></div>
      <div style="margin-top:10px"><button class="btn" id="btnCancelOnline">Cancelar</button></div>
    </div>
  </div>
</section>

<script type="module">
  // Utilidad UI
  const qs = s => document.querySelector(s);
  const qsa = s => [...document.querySelectorAll(s)];
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
  const rnd = (a,b)=> Math.random()*(b-a)+a;
  const lerp=(a,b,t)=>a+(b-a)*t;
  const hsl=(h,s,l,a=1)=>`hsla(${h},${s}%,${l}%,${a})`;
  function showScreen(el){ el.classList.add('show'); el.style.display='block'; }
  function hideScreen(el){ el.classList.remove('show'); el.classList.add('fade-out'); setTimeout(()=>{ el.style.display='none'; el.classList.remove('fade-out'); }, 240); }
  function switchSections(hideSel, showSel){
    const a = qs(hideSel), b = qs(showSel);
    if (a && a.style.display!=='none') hideScreen(a);
    if (b){ b.style.display='block'; requestAnimationFrame(()=> showScreen(b)); }
  }
  function openModal(id){ const el = qs(id); el.style.display='flex'; showScreen(el); }
  function closeModal(id){ hideScreen(qs(id)); }

  // Splash -> menú
  setTimeout(()=>{ qs('#splash').style.display='none'; qs('#menu').style.display='block'; showScreen(qs('#menu')); renderSpaceBG(); updateIPText(); }, 1400);

  // Estado jugador
  const playerData = {
    username: null, email: null, uid: null,
    ip: null, country: null, geoAccepted: false,
    pointsGlobal: 0, levelGlobal: 1,
    soundOn: true
  };
  function refreshPlayerStateUI(){
    qs('#psUser').textContent = playerData.username || '—';
    qs('#psPoints').textContent = playerData.pointsGlobal;
    qs('#psLevel').textContent = playerData.levelGlobal;
    qs('#accountReq').textContent = playerData.uid ? 'Sesión activa: online habilitado' : 'Sin sesión: online limitado';
    updateIPText();
  }

  // Fondo menú
  function renderSpaceBG(){
    const c = qs('#spaceBG'); const ctx = c.getContext('2d');
    let W=innerWidth, H=innerHeight; c.width=W; c.height=H;
    const stars = Array.from({length:300}).map(()=>({x:rnd(0,W), y:rnd(0,H), r:rnd(0.4,1.6), s:rnd(0.2,0.9)}));
    function loop(){
      ctx.clearRect(0,0,W,H);
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0, '#06091a'); g.addColorStop(1, '#02030a'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      stars.forEach(s=>{
        s.y += s.s*0.15; if(s.y>H) s.y=0; ctx.globalAlpha = 0.6;
        ctx.fillStyle = Math.random()<0.33? '#2df7ff' : Math.random()<0.66? '#ff3a8c' : '#7bff7b';
        ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
      });
      requestAnimationFrame(loop);
    }
    loop();
    addEventListener('resize', ()=>{ W=innerWidth; H=innerHeight; c.width=W; c.height=H; });
  }

  // Sonidos
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  const sounds = { shoot:{freq:680,type:'square',dur:0.06}, explode:{freq:140,type:'sawtooth',dur:0.22}, pickup:{freq:980,type:'triangle',dur:0.12}, level:{freq:520,type:'square',dur:0.20}, boss:{freq:240,type:'sawtooth',dur:0.35}, death:{freq:90,type:'sawtooth',dur:0.6} };
  function playSound(key){
    if (!playerData.soundOn) return; if (!audioCtx) audioCtx = new AudioCtx();
    const s = sounds[key]; if (!s) return;
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.type = s.type; osc.frequency.value = s.freq; const t = audioCtx.currentTime;
    gain.gain.setValueAtTime(0.0001, t); gain.gain.exponentialRampToValueAtTime(0.3, t+0.02); gain.gain.exponentialRampToValueAtTime(0.0001, t+s.dur);
    osc.connect(gain).connect(audioCtx.destination); osc.start(t); osc.stop(t+s.dur+0.02);
  }
  const soundToggle = qs('#soundToggle'); soundToggle.addEventListener('click', ()=>{ playerData.soundOn=!playerData.soundOn; soundToggle.classList.toggle('on', playerData.soundOn); soundToggle.querySelector('.toggle-dot').style.background = playerData.soundOn ? '#55ff88' : '#ff6677'; });
  soundToggle.classList.toggle('on', playerData.soundOn); soundToggle.querySelector('.toggle-dot').style.background = '#55ff88';

  // Geolocalización real
  async function requestGeolocationCountry(){
    if (!('geolocation' in navigator)) throw new Error('Geolocalización no disponible en este navegador.');
    const pos = await new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    });
    const { latitude, longitude } = pos.coords;
    const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=es`;
    const data = await fetch(url).then(r=>r.json());
    const country = data.countryName || data.principalSubdivision || data.locality || '—';
    return { country, lat: latitude, lon: longitude };
  }

  // IP
  async function fetchIP(){ try{ const ip = await fetch('https://api.ipify.org?format=json').then(r=>r.json()); playerData.ip = ip.ip || null; }catch(e){ playerData.ip=null; } }
  function updateIPText(){ const geoText = `${playerData.country || '—'} / ${playerData.ip || '—'}`; qs('#psGeo').textContent = geoText; qs('#pfGeo').textContent = geoText; }

  // Firebase
  let fb=null;
  async function ensureFirebase(){
    if (fb) return fb;
    const scripts = [
      'https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js',
      'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js'
    ];
    for (const src of scripts){
      await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    }
    const firebaseConfig = {
      apiKey: "AIzaSyBWqJI7OKZcEjN2CeTZxPi8pWzo8rBMIkI",
      authDomain: "nearmemarketplace-ce82b.firebaseapp.com",
      projectId: "nearmemarketplace-ce82b",
      storageBucket: "nearmemarketplace-ce82b.firebasestorage.app",
      messagingSenderId: "711845990024",
      appId: "1:711845990024:web:7948ad5e5606765514d93d"
    };
    fb = { app: firebase.initializeApp(firebaseConfig), auth: firebase.auth(), db: firebase.firestore() };

    fb.auth.onAuthStateChanged(async (user)=>{
      if (user){
        playerData.uid = user.uid;
        const {db} = await ensureFirebase();
        await fetchIP();
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists){
          const d = doc.data();
          playerData.username = d.username || user.email?.split('@')[0] || 'Jugador';
          playerData.pointsGlobal = d.pointsGlobal || 0;
          playerData.levelGlobal = d.levelGlobal || 1;
          playerData.country = d.country || playerData.country || null;
          playerData.ip = playerData.ip || d.ip || null;
        }else{
          playerData.username = user.email?.split('@')[0] || 'Jugador';
          await db.collection('users').doc(user.uid).set({
            username: playerData.username, pointsGlobal: 0, levelGlobal: 1,
            ip: playerData.ip || null, country: playerData.country || null, createdAt: Date.now()
          }, {merge:true});
        }
        qs('#pfConnected').textContent='Sí'; qs('#pfUID').textContent=user.uid;
        updateIPText(); refreshPlayerStateUI(); loadLeaderboard();
      } else {
        playerData.uid = null; qs('#pfConnected').textContent='No'; qs('#pfUID').textContent='—'; refreshPlayerStateUI();
      }
    });
    return fb;
  }
  ensureFirebase();

  async function persistGlobal(){
    if (!playerData.uid) return;
    try{
      const {db}= await ensureFirebase();
      await db.collection('users').doc(playerData.uid).set({
        username: playerData.username,
        pointsGlobal: playerData.pointsGlobal,
        levelGlobal: playerData.levelGlobal,
        country: playerData.country || '—',
        ip: playerData.ip || null,
        updatedAt: Date.now()
      }, {merge:true});
    }catch(e){}
  }

  async function register(){
    const {auth, db} = await ensureFirebase();
    const email = qs('#pfEmail').value.trim();
    const pass = qs('#pfPassword').value.trim();
    const username = (qs('#pfUsername').value.trim()) || email.split('@')[0];

    // Geolocalización (permiso real)
    try{
      const geo = await requestGeolocationCountry();
      playerData.country = geo.country; playerData.geoAccepted = true;
      qs('#pfGeoNote').textContent = `País detectado: ${geo.country}`;
    }catch(e){
      alert('No se pudo obtener ubicación. Puedes intentarlo luego.');
    }

    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    playerData.uid = cred.user.uid; playerData.email=email; playerData.username=username;
    await fetchIP();
    await db.collection('users').doc(playerData.uid).set({
      username, email,
      pointsGlobal: 0, levelGlobal: 1,
      ip: playerData.ip||null, country: playerData.country || '—',
      createdAt: Date.now()
    }, {merge:true});
    qs('#pfConnected').textContent='Sí'; qs('#pfUID').textContent=playerData.uid;
    refreshPlayerStateUI();
    alert('Registro completado.');
  }
  async function login(){
    const {auth, db} = await ensureFirebase();
    const email = qs('#pfEmail').value.trim();
    const pass = qs('#pfPassword').value.trim();
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const uid = cred.user.uid; playerData.uid=uid; playerData.email=email;
    await fetchIP();
    const doc = await db.collection('users').doc(uid).get();
    if (doc.exists){
      const d = doc.data();
      playerData.username = d.username || email.split('@')[0];
      playerData.pointsGlobal = d.pointsGlobal || 0;
      playerData.levelGlobal = d.levelGlobal || 1;
      playerData.country = d.country || playerData.country || null;
      await db.collection('users').doc(uid).set({ ip: playerData.ip||null, updatedAt: Date.now() }, {merge:true});
    } else {
      playerData.username = email.split('@')[0];
      await db.collection('users').doc(uid).set({
        username: playerData.username, pointsGlobal: 0, levelGlobal: 1,
        ip: playerData.ip || null, country: playerData.country || '—',
        createdAt: Date.now()
      }, {merge:true});
    }
    qs('#pfConnected').textContent='Sí'; qs('#pfUID').textContent=uid;
    updateIPText(); refreshPlayerStateUI(); loadLeaderboard();
    alert('Sesión iniciada.');
  }
  async function logout(){ try{ const {auth}= await ensureFirebase(); await auth.signOut(); }catch(e){} playerData.uid=null; qs('#pfConnected').textContent='No'; qs('#pfUID').textContent='—'; refreshPlayerStateUI(); }

  // Perfil: detectar ubicación
  qs('#btnAcceptGeo').addEventListener('click', async ()=>{
    try{
      const geo = await requestGeolocationCountry();
      playerData.country = geo.country; playerData.geoAccepted = true;
      qs('#pfGeoNote').textContent = `País detectado: ${geo.country}`;
      await persistGlobal(); updateIPText();
    }catch(e){ alert('No se pudo obtener ubicación.'); }
  });

  // Ranking / Historial
  async function loadLeaderboard(){
    const tbody = qs('#rankTable'); if (!tbody) return; tbody.innerHTML='';
    try{
      const {db}= await ensureFirebase();
      const snap = await db.collection('leaderboard').orderBy('points','desc').limit(50).get();
      snap.forEach(doc=>{
        const d=doc.data();
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${d.username||'—'}</td><td>${d.rank||'—'}</td><td>${d.points||0}</td><td>${d.country||'—'}</td>`;
        tbody.appendChild(tr);
      });
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="4">No disponible (offline)</td></tr>`;
    }
  }
  function openHistory(){
    const key='nsf_history';
    const list = JSON.parse(localStorage.getItem(key)||'[]');
    const tbody = qs('#historyTable'); tbody.innerHTML='';
    list.forEach(h=>{
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${new Date(h.ts).toLocaleString()}</td><td>${h.points}</td><td>${h.level}</td><td>${h.mode}</td>`;
      tbody.appendChild(tr);
    });
    openModal('#modalHistory');
  }
  qs('#btnResetProgress').addEventListener('click', ()=>{ localStorage.removeItem('nsf_normal_progress_level'); alert('Progreso reiniciado a nivel 1.'); });

  // Botones menú/modales
  qsa('[data-close]').forEach(btn=> btn.addEventListener('click', ()=>{ const id = btn.getAttribute('data-close'); closeModal(id); showScreen(qs('#menu')); qs('#menu').style.display='block'; }));
  qs('#btnProfile').addEventListener('click', ()=> openModal('#modalProfile'));
  qs('#btnRanking').addEventListener('click', ()=> { openModal('#modalRanking'); loadLeaderboard(); });
  qs('#btnHistory').addEventListener('click', openHistory);
  qs('#btnRegister').addEventListener('click', ()=>register().catch(err=>alert(err.message)));
  qs('#btnLogin').addEventListener('click', ()=>login().catch(err=>alert(err.message)));
  qs('#btnLogout').addEventListener('click', ()=>logout().catch(()=>{}));
  qs('#btnPlay').addEventListener('click', ()=> startGame('Normal'));
  qs('#btnQuit').addEventListener('click', async ()=>{ await logout(); alert('Sesión cerrada.'); });

  // Online: salas 2–4 jugadores
  const MAX_ROOM_PLAYERS = 4;
  let currentRoomId = null;
  let presenceUnsub = null;
  let roomUnsub = null;

  const remotePlayers = new Map(); // uid -> {x,y,name,color}
  const nameTags = new Map();
  function addNameTag(id, text, color='#eaf3ff'){
    let el = nameTags.get(id);
    if (!el){ el = document.createElement('div'); el.className='name-tag'; document.body.appendChild(el); nameTags.set(id, el); }
    el.textContent = text; el.style.boxShadow = `0 0 12px ${color}33`;
  }
  function positionNameTag(id, x, y){ const el = nameTags.get(id); if (!el) return; el.style.left = x+'px'; el.style.top = y+'px'; }
  function removeAllNameTags(){ nameTags.forEach(el=> el.remove()); nameTags.clear(); }

  async function autoMatchRoom(){
    const {db} = await ensureFirebase();
    const roomsRef = db.collection('rooms');
    // Busca sala 'open' con huecos
    const snap = await roomsRef.where('status','==','open').orderBy('createdAt','asc').limit(20).get();
    let target = null;
    snap.forEach(doc=>{
      const d = doc.data();
      if ((d.members?.length || 0) < MAX_ROOM_PLAYERS) target = {id: doc.id, data:d};
    });
    if (!target){
      const newRoom = await roomsRef.add({ status:'open', createdAt: Date.now(), members: [] });
      target = {id:newRoom.id, data:{members:[], status:'open'}};
    }
    currentRoomId = target.id;
    await roomsRef.doc(currentRoomId).set({
      status: 'open',
      updatedAt: Date.now(),
      members: firebase.firestore.FieldValue.arrayUnion({
        uid: playerData.uid,
        name: playerData.username || 'Jugador',
        joinedAt: Date.now(),
        ready: false
      })
    }, {merge:true});
    const doc = await roomsRef.doc(currentRoomId).get();
    const mcount = (doc.data()?.members||[]).length;
    if (mcount >= MAX_ROOM_PLAYERS){
      await roomsRef.doc(currentRoomId).set({ status: 'full', updatedAt: Date.now() }, {merge:true});
    }
    return currentRoomId;
  }

  function startPresenceLoop(roomId){
    const {db} = fb;
    const presenceRef = db.collection('rooms').doc(roomId).collection('presence');
    const meId = playerData.uid;
    let lastPresenceSend = 0;
    function tick(){
      const now = Date.now();
      if (now - lastPresenceSend >= 80 && running && !paused){
        presenceRef.doc(meId).set({
          uid: meId,
          name: playerData.username || 'Yo',
          x: player.x, y: player.y,
          alive: player.alive,
          t: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        lastPresenceSend = now;
      }
      requestAnimationFrame(tick);
    }
    tick();
    if (presenceUnsub) presenceUnsub();
    presenceUnsub = presenceRef.onSnapshot(snap=>{
      snap.docChanges().forEach(ch=>{
        const data = ch.doc.data();
        if (!data || data.uid===playerData.uid) return;
        remotePlayers.set(data.uid, {
          x:data.x||0, y:data.y||0,
          name:data.name||'Jugador',
          color:'#2df7ff'
        });
        addNameTag(data.uid, data.name||'Jugador', '#2df7ff');
      });
    });
  }

  async function connectOnline(roomId){
    const {db} = await ensureFirebase();
    const roomsRef = db.collection('rooms').doc(roomId);

    if (roomUnsub) roomUnsub();
    roomUnsub = roomsRef.onSnapshot(async snap=>{
      const d = snap.data(); if (!d) return;
      const members = d.members || [];
      const meId = playerData.uid;
      const updatedMembers = members.map(m=> (m.uid===meId && !m.ready) ? ({...m, ready:true}) : m);

      if (JSON.stringify(updatedMembers) !== JSON.stringify(members)){
        await roomsRef.set({ members: updatedMembers, updatedAt: Date.now() }, {merge:true});
      }

      const readyCount = updatedMembers.filter(m=>m.ready).length;
      // Arranque automático: al menos 2 listos
      if (readyCount >= 2 && !running){
        hideScreen(qs('#waitingOnline'));
        startGame('Competencia');
        startPresenceLoop(roomId);
      }

      // Crear etiquetas
      members.forEach(m=> addNameTag(m.uid, m.name || 'Jugador', '#2df7ff'));
    });
  }

  qs('#btnPlayOnline').addEventListener('click', async ()=>{
    if (!playerData.uid){ alert('Inicia sesión para jugar online.'); return; }
    // Entrar al juego con overlay de espera
    startGame('Competencia');
    showScreen(qs('#waitingOnline'));
    const roomId = await autoMatchRoom().catch(()=>null);
    if (!roomId){ alert('No se pudo crear/entrar a sala'); hideScreen(qs('#waitingOnline')); return; }
    connectOnline(roomId);
  });
  qs('#btnCancelOnline').addEventListener('click', ()=>{
    hideScreen(qs('#waitingOnline'));
  });

  // Juego base
  const canvas = qs('#canvas'); const ctxGame = canvas.getContext('2d'); let W=innerWidth, H=innerHeight;
  function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; } addEventListener('resize', resize); resize();

  const player = { x:W*0.5, y:H*0.72, vx:0, vy:0, angle:-Math.PI/2, speed:320, fireCd:0, fireRate:0.18, alive:true, invul:0 };
  const bullets=[]; const missiles=[]; const asteroids=[]; const pickups=[]; const particles=[]; const bosses=[];
  const enemyBullets=[];
  const powers = {
    Magnet:{active:false,until:0,color:'#2df7ff'},
    Drone:{active:false,until:0,color:'#ff3a8c',angle:0,rx:0,ry:0},
    Vortex:{active:false,until:0,color:'#7bff7b'},
    Shield:{active:false,until:0,color:'#a0c8ff'},
    Double:{active:false,until:0,color:'#ffd166'},
    Burst:{active:false,until:0,color:'#ff8a3a'},
    Missiles:{active:false,until:0,color:'#ff5544'},
    Heart:{active:false,until:0,color:'#ff4d6d'}
  };
  const powerDur = 20_000;
  const ASTEROID_POINTS = 5;
  let last=0, screenShake=0, flashShot=0, levelBgHue=210, inBoss=false, currentBossHP=0, currentBossMax=0;

  let comboChain = 0, lastKillTs = 0;
  function onAsteroidKill(){
    const now = Date.now(); if (now - lastKillTs <= 1200){ comboChain++; } else { comboChain = 1; } lastKillTs = now;
    const word = comboChain>=6? 'FIRE' : comboChain>=4? 'AMAZING' : comboChain>=2? 'GREAT' : 'GOOD';
    const el = qs('#comboBanner'); el.textContent = word; el.classList.remove('combo-in'); void el.offsetWidth; el.classList.add('combo-in');
  }

  function requiredPoints(level){ return 250 * level; }
  function checkLevelUp(){
    const req = requiredPoints(match.level);
    if (match.points >= req){
      match.points -= req;
      match.level++;
      qs('#hudLevel').textContent = match.level;
      levelBgHue = (levelBgHue + 43)%360;
      showLevelBanner(match.level);
      if (match.level % 5 === 0){ startBossFight(); }
      if (gameMode==='Normal'){ localStorage.setItem('nsf_normal_progress_level', String(match.level)); }
    }
  }
  function showLevelBanner(n){ const el = qs('#levelBanner'); el.textContent = `Nivel ${n}`; el.classList.remove('level-in'); void el.offsetWidth; el.classList.add('level-in'); playSound('level'); }

  const keys={};
  addEventListener('keydown', e=>{ keys[e.code]=true; if(e.code==='Space') shoot(); if(e.code==='KeyP') togglePause(); });
  addEventListener('keyup', e=>{ keys[e.code]=false; });

  const ctx = ctxGame;

  // Asteroides
  function drawAsteroid(a){
    ctx.save(); ctx.translate(a.x,a.y);
    const hue = a.type==='ice'? 190 : a.type==='metal'? 220 : a.type==='lava'? 15 : 200;
    const col = hsl(hue, 70, 60);
    ctx.strokeStyle = col; ctx.lineWidth = 2; ctx.shadowColor = col; ctx.shadowBlur = 8;
    ctx.beginPath();
    for(let i=0;i<a.sides;i++){
      const ang = (Math.PI*2)*(i/a.sides) + a.rot;
      const r = a.size + Math.sin(a.jitter+i)*3;
      const px = Math.cos(ang)*r, py = Math.sin(ang)*r;
      if (i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }
  function spawnAsteroid(){
    if (inBoss) return;
    const lvl = match.level;
    const sizeBase = rnd(16, 52);
    const hpBase = sizeBase<22?1: sizeBase<32?2: sizeBase<42?3:4;
    const hpScale = 1 + Math.min(2.5, lvl*0.06);
    const hp = Math.ceil(hpBase * hpScale);
    const speedScale = 1 + Math.min(2.2, lvl*0.05);
    const x = rnd(0, W), y = -60;
    const vx = rnd(-60, 60)*speedScale, vy = rnd(90, 190 + lvl*5)*speedScale;
    const typePool = ['ice','metal','lava']; const type = typePool[Math.floor(rnd(0,typePool.length))];
    const sides = Math.floor(rnd(5,8));
    asteroids.push({x,y,vx,vy,size:sizeBase, hp, type, sides, rot:rnd(0,Math.PI*2), jitter:rnd(0,Math.PI*2)});
  }

  // Poderes y HUD
  function powerIconSVG(kind, color){
    const base = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">`;
    if (kind==='Magnet') return base + `<path d="M6 7v6a6 6 0 0 0 12 0V7" /><path d="M6 7h12" /></svg>`;
    if (kind==='Drone') return base + `<circle cx="12" cy="12" r="4"/><path d="M4 12h16"/></svg>`;
    if (kind==='Vortex') return base + `<path d="M12 5c3 3-3 6 0 9s-3 6 0 9" /></svg>`;
    if (kind==='Shield') return base + `<path d="M12 3l8 4v6c0 5-4 8-8 8s-8-3-8-8V7z"/></svg>`;
    if (kind==='Double') return base + `<path d="M5 18l6-12 8 12"/><path d="M9 18l6-12"/></svg>`;
    if (kind==='Burst') return base + `<path d="M12 2v20"/><path d="M2 12h20"/></svg>`;
    if (kind==='Missiles') return base + `<path d="M12 2l4 8-4 4-4-4 4-8z"/><path d="M12 14v8"/></svg>`;
    if (kind==='Heart') return `<svg width="16" height="16" viewBox="0 0 24 24" fill="#ff4d6d"><path d="M12 21s-7-4.35-7-9a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 4.65-7 9-7 9Z"/></svg>`;
    return base + `</svg>`;
  }
  function drawPowerIcon(kind, x, y){
    const ctx = ctxGame; ctx.save(); ctx.translate(x,y); ctx.lineWidth=2; ctx.strokeStyle = powers[kind].color; ctx.shadowColor=powers[kind].color; ctx.shadowBlur=6;
    ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.stroke();
    if (kind==='Drone'){ ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(-8,-6); ctx.lineTo(-8,6); ctx.closePath(); ctx.stroke(); }
    else if (kind==='Magnet'){ ctx.beginPath(); ctx.moveTo(-6,-4); ctx.lineTo(-6,6); ctx.arc(0,6,6,Math.PI,0); ctx.lineTo(6,-4); ctx.stroke(); }
    else if (kind==='Heart'){ ctx.fillStyle = '#ff4d6d'; ctx.beginPath(); ctx.moveTo(-4,0); ctx.bezierCurveTo(-4,-4,0,-4,0,-2); ctx.bezierCurveTo(0,-4,4,-4,4,0); ctx.bezierCurveTo(4,3,0,6,0,8); ctx.bezierCurveTo(0,6,-4,3,-4,0); ctx.fill(); }
    ctx.restore();
  }
  function spawnPickup(x,y){ if (Math.random()>0.10) return; const kinds = Object.keys(powers); const k = kinds[Math.floor(rnd(0,kinds.length))]; pickups.push({x,y, vx:rnd(-40,40), vy:rnd(40,90), kind:k, r:12}); }
  function activatePower(kind){
    if (kind==='Heart'){ match.lives++; qs('#hudLives').textContent = match.lives; playSound('pickup'); return; }
    const p = powers[kind]; p.active=true; p.until = Date.now()+powerDur;
    if (kind==='Drone'){ p.angle = 0; p.rx = player.x+38; p.ry = player.y; }
    playSound('pickup');
  }
  function updatePowersUI(){
    const container = qs('#hudPowers'); container.innerHTML='';
    const t = Date.now();
    for (const [k,v] of Object.entries(powers)){
      if (!v.active) continue;
      const left = Math.max(0, v.until - t);
      const mm = Math.floor(left/60000), ss = Math.floor((left%60000)/1000);
      const chip = document.createElement('div'); chip.className='btn'; chip.style.borderRadius='999px'; chip.style.padding='6px 10px'; chip.style.gap='8px'; chip.style.display='inline-flex'; chip.style.alignItems='center';
      chip.innerHTML = `${powerIconSVG(k, v.color)}<span style="font-weight:700">${k}</span><span class="timer" style="opacity:.8">${mm}:${String(ss).padStart(2,'0')}</span>`;
      container.appendChild(chip);
      if (left<=0){ v.active=false; }
    }
  }

  // Drone auxiliar: nave real orbitando y disparando a asteroides
  function droneLogic(dt){
    if (!powers.Drone.active) return;
    const d = powers.Drone;
    d.angle += dt*2.1;
    d.rx = player.x + Math.cos(d.angle)*38;
    d.ry = player.y + Math.sin(d.angle)*38;

    // Dibuja la nave auxiliar
    ctx.save();
    ctx.translate(d.rx, d.ry);
    ctx.strokeStyle = d.color; ctx.lineWidth=2.2; ctx.shadowColor=d.color; ctx.shadowBlur=8;
    ctx.beginPath();
    ctx.moveTo(14,0); ctx.lineTo(-10,-8); ctx.lineTo(-10,8); ctx.closePath(); ctx.stroke();
    ctx.restore();

    // Disparo automático hacia el asteroide/boss más cercano
    if (Math.random()<0.06){
      let target = null;
      for (const a of asteroids){
        if (!target || Math.hypot(a.x-d.rx, a.y-d.ry) < Math.hypot(target.x-d.rx, target.y-d.ry)) target = a;
      }
      if (!target && bosses[0]) target = bosses[0];
      const angle = target ? Math.atan2(target.y-d.ry, target.x-d.rx) : -Math.PI/2;
      bullets.push({
        x:d.rx, y:d.ry,
        vx:Math.cos(angle)*640, vy:Math.sin(angle)*640,
        r:3.5, life:1500, drone:true
      });
    }
  }

  // Jefe
  function startBossFight(){ inBoss = true; asteroids.length = 0; spawnBoss(); qs('#bossBarWrap').style.display = 'flex'; }
  function endBossFight(){ inBoss = false; qs('#bossBarWrap').style.display = 'none'; }
  function spawnBoss(){
    const shapes = ['tri','quad','ring','hydra'];
    const shape = shapes[Math.floor(rnd(0,shapes.length))];
    const hp = 140 + match.level*14;
    bosses.push({x:W*0.5, y:120, vx:rnd(-70,70), vy:0, hp, shape, fire:0, phase:0});
    currentBossHP = hp; currentBossMax = hp;
    qs('#bossName').textContent = `Jefe ${shape.toUpperCase()}`;
    qs('#bossBarFill').style.width = '100%';
    playSound('boss');
  }

  // Disparo
  function shoot(){
    if (!player.alive) return;
    if (player.fireCd>0) return;
    player.fireCd = powers.Burst.active ? 0.06 : player.fireRate;
    flashShot = 120;
    const speed = 640;
    const makeBullet=(offset=0)=> bullets.push({x:player.x+Math.cos(player.angle)*16 + offset, y:player.y+Math.sin(player.angle)*16, vx:Math.cos(player.angle)*speed, vy:Math.sin(player.angle)*speed, r:4, life:1800});
    if (powers.Double.active){ makeBullet(-10); makeBullet(10); } else { makeBullet(0); }
    playSound('shoot');
  }

  // Partículas y colisiones
  function explosionParticle(x,y,scale=1){ const c = hsl(Math.floor(rnd(0,360)), 80, 60); return {x,y, vx:rnd(-160,160)*scale, vy:rnd(-160,160)*scale, life:rnd(300,800), color:c, r:rnd(2,6)*scale}; }
  function circleHit(ax,ay,ar,bx,by,br){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy <= (ar+br)*(ar+br); }
  function hitPlayer(force=1){
    if (powers.Shield.active || player.invul>0) return;
    match.lives -= force; player.invul = 1000; screenShake = Math.max(screenShake, 14);
    for (let k=0;k<20;k++) particles.push(explosionParticle(player.x,player.y,1.0));
    playSound('explode');
    if (match.lives<=0){ player.alive=false; triggerGameOver(); }
    qs('#hudLives').textContent = match.lives;
  }

  // Render
  function renderBackground(){
    const g = ctx.createLinearGradient(0,0,0,H);
    const hue = (levelBgHue + match.level*17)%360;
    g.addColorStop(0, hsl(hue, 50, 6)); g.addColorStop(1, hsl((hue+60)%360, 60, 3));
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 0.45;
    const starCount = 50 + Math.min(80, match.level*3);
    for (let i=0;i<starCount;i++){
      const x = (i*37 + match.level*23)%W; const y = (i*59 + match.level*31)%H;
      ctx.fillStyle = i%3===0? '#2df7ff' : i%3===1? '#ff3a8c' : '#7bff7b';
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;
  }
  function renderShip(){
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    if (powers.Shield.active){ ctx.strokeStyle = 'rgba(160,200,255,.55)'; ctx.lineWidth = 2.2; ctx.beginPath(); ctx.arc(0,0, 24, 0, Math.PI*2); ctx.stroke(); }
    ctx.strokeStyle = '#2df7ff'; ctx.lineWidth=2.6; ctx.shadowColor='#2df7ff'; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-16,-12); ctx.lineTo(-16,12); ctx.closePath(); ctx.stroke();
    ctx.restore();
  }
  function renderRemotePlayers(){
    remotePlayers.forEach((rp, uid)=>{
      ctx.save(); ctx.translate(rp.x, rp.y);
      ctx.strokeStyle = rp.color; ctx.lineWidth=2.2; ctx.shadowColor=rp.color; ctx.shadowBlur=10;
      ctx.beginPath(); ctx.moveTo(18,0); ctx.lineTo(-14,-12); ctx.lineTo(-14,12); ctx.closePath(); ctx.stroke();
      ctx.restore();
      positionNameTag(uid, rp.x, rp.y);
    });
  }
  function renderFlash(){ if (flashShot>0){ const alpha = Math.min(0.25, flashShot/2000); ctx.fillStyle = `rgba(255,255,255,${alpha})`; ctx.fillRect(0,0,W,H); flashShot -= 16; } }
  function renderParticles(dt){
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i]; p.life -= dt*1000; p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 20*dt;
      ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.life/800);
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
      if (p.life<=0) particles.splice(i,1);
    }
  }
  function renderBullets(dt){
    ctx.fillStyle = '#dbe8ff';
    for (let i=bullets.length-1;i>=0;i--){
      const b = bullets[i]; b.x += b.vx*dt; b.y += b.vy*dt; b.life -= dt*1000;
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
      if (b.life<=0 || b.y< -40 || b.x<-40 || b.x>W+40) bullets.splice(i,1);
    }
    ctx.fillStyle = '#ffd166';
    for (let i=enemyBullets.length-1;i>=0;i--){
      const eb = enemyBullets[i]; eb.x += eb.vx*dt; eb.y += eb.vy*dt; eb.life -= dt*1000;
      ctx.beginPath(); ctx.arc(eb.x, eb.y, eb.r, 0, Math.PI*2); ctx.fill();
      if (circleHit(player.x, player.y, 14, eb.x, eb.y, eb.r)){ enemyBullets.splice(i,1); hitPlayer(); continue; }
      if (eb.life<=0 || eb.y>H+40 || eb.x<-40 || eb.x>W+40) enemyBullets.splice(i,1);
    }
  }
  function renderAsteroids(dt){
    for (let i=asteroids.length-1;i>=0;i--){
      const a = asteroids[i]; a.x += a.vx*dt; a.y += a.vy*dt; a.rot += dt*0.6; a.jitter += dt*1.2;
      drawAsteroid(a);
      for (let j=bullets.length-1;j>=0;j--){
        const b=bullets[j];
        if (circleHit(a.x,a.y,a.size, b.x,b.y,b.r)){
          a.hp--; bullets.splice(j,1); playSound('explode');
          screenShake = Math.max(screenShake, 6);
          for (let k=0;k<6;k++) particles.push(explosionParticle(a.x,a.y,0.4));
          if (a.hp<=0){
            onAsteroidKill();
            spawnPickup(a.x,a.y);
            match.points += ASTEROID_POINTS; qs('#hudScore').textContent = match.points;
            asteroids.splice(i,1); break;
          }
        }
      }
      if (circleHit(a.x,a.y,a.size, player.x,player.y, 14)){ hitPlayer(); asteroids.splice(i,1); }
      if (a.y>H+80) asteroids.splice(i,1);
    }
  }

  // Boss render y colisiones
  function renderBosses(dt){
    for (let i=bosses.length-1;i>=0;i--){
      const b = bosses[i];
      b.x += b.vx*dt; if (b.x<80 || b.x>W-80) b.vx *= -1;
      ctx.save(); ctx.translate(b.x,b.y); ctx.strokeStyle = '#ff6f3a'; ctx.lineWidth=3; ctx.shadowColor='#ff6f3a'; ctx.shadowBlur=12;
      ctx.beginPath(); ctx.arc(0,0,22,0,Math.PI*2); ctx.stroke();
      ctx.restore();
      for (let j=bullets.length-1;j>=0;j--){
        const bl = bullets[j]; if (circleHit(b.x,b.y,24, bl.x,bl.y, bl.r)){
          b.hp -= 1; bullets.splice(j,1);
          particles.push(explosionParticle(b.x,b.y,0.8)); playSound('explode');
          screenShake = Math.max(screenShake, 10);
          currentBossHP = b.hp; qs('#bossBarFill').style.width = clamp(currentBossHP/currentBossMax,0,1)*100+'%';
          if (b.hp<=0){
            match.points += 200 + Math.floor(match.level*4); qs('#hudScore').textContent = match.points;
            for (let k=0;k<20;k++) particles.push(explosionParticle(b.x,b.y,1.1));
            spawnPickup(b.x,b.y); bosses.splice(i,1); endBossFight(); break;
          }
        }
      }
    }
  }

  function triggerGameOver(){
    paused=true;
    playSound('death');
    for (let k=0;k<60;k++) particles.push(explosionParticle(player.x, player.y, 1.5));
    qs('#goPoints').textContent = match.points; qs('#goLevel').textContent = match.level; qs('#goMode').textContent = gameMode;
    const go = qs('#gameOverOverlay'); showScreen(go);
    const entry = { ts: Date.now(), points: match.points, level: match.level, mode: gameMode };
    saveHistoryEntry(entry);
    if (gameMode==='Normal'){ localStorage.setItem('nsf_normal_progress_level', String(match.level)); }
    if (gameMode==='Competencia'){
      playerData.pointsGlobal += match.points;
      playerData.levelGlobal = Math.max(playerData.levelGlobal, match.level);
      persistGlobal().catch(()=>{});
      ensureFirebase().then(({db})=>{
        db.collection('leaderboard').doc(playerData.uid||String(Date.now())).set({
          username: playerData.username||'Jugador',
          points: playerData.pointsGlobal,
          rank: '—',
          country: playerData.country || '—',
          updatedAt: Date.now()
        }, {merge:true});
      });
    }
    refreshPlayerStateUI();
    removeAllNameTags();
  }

  function updateGame(dt){
    if (!running || paused) return;
    const ax = (keys['KeyA']||keys['ArrowLeft']?-1:0) + (keys['KeyD']||keys['ArrowRight']?1:0);
    const ay = (keys['KeyW']||keys['ArrowUp']?-1:0) + (keys['KeyS']||keys['ArrowDown']?1:0);
    player.vx = ax * player.speed; player.vy = ay * player.speed;
    player.x = clamp(player.x + player.vx*dt, 20, W-20);
    player.y = clamp(player.y + player.vy*dt, 20, H-20);
    player.angle = -Math.PI/2 + ax*0.25;
    if (keys['Space']) shoot();
    if (player.fireCd>0) player.fireCd -= dt;
    if (player.invul>0) player.invul -= dt*1000;

    renderBackground();
    updateSpawns(dt);
    droneLogic(dt);

    const sx = screenShake>0? rnd(-screenShake,screenShake):0;
    const sy = screenShake>0? rnd(-screenShake,screenShake):0;
    ctx.save(); ctx.translate(sx, sy);

    renderShip();
    renderRemotePlayers();
    renderBullets(dt);
    renderAsteroids(dt);
    renderBosses(dt);
    renderParticles(dt);
    renderFlash();

    ctx.restore();
    screenShake = Math.max(0, screenShake - dt*20);
    updatePowersUI();
    checkLevelUp();

    // posiciona tu etiqueta si estás en competencia
    if (gameMode==='Competencia' && playerData.uid){
      positionNameTag(playerData.uid, player.x, player.y);
    }
  }
  let spawnTimer=0;
  function updateSpawns(dt){
    spawnTimer -= dt;
    const base = 0.95 - match.level*0.02;
    const targetSpawn = Math.max(0.25, base);
    if (spawnTimer<=0){ spawnAsteroid(); spawnTimer = targetSpawn; }
  }
  function loop(t){ const dt = Math.min(0.033, (t-last)/1000 || 0); last = t; updateGame(dt); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  // Progreso Normal persistente
  function getSavedNormalLevel(){
    const v = localStorage.getItem('nsf_normal_progress_level');
    const n = v ? parseInt(v,10) : 1;
    return isNaN(n) || n<1 ? 1 : n;
  }

  let match = { points:0, level:1, lives:3 };
  let gameMode = 'Normal';
  let running=false, paused=false;

  function startGame(mode='Normal'){
    gameMode = mode; qs('#hudMode').textContent = mode;
    switchSections('#menu', '#game'); running=true; paused=false;
    const startLevel = mode==='Normal' ? getSavedNormalLevel() : 1;
    match = { points:0, level:startLevel, lives:3 };
    bullets.length=0; missiles.length=0; enemyBullets.length=0; asteroids.length=0; pickups.length=0; particles.length=0; bosses.length=0;
    inBoss=false; qs('#bossBarWrap').style.display='none';
    player.alive=true; player.invul=0; player.x=W*0.5; player.y=H*0.72; player.angle=-Math.PI/2;
    qs('#hudScore').textContent = match.points; qs('#hudLevel').textContent = match.level; qs('#hudLives').textContent = match.lives;
    showLevelBanner(match.level);
    if (mode!=='Competencia'){ removeAllNameTags(); currentRoomId=null; }
  }
  function exitGame(){
    running=false; paused=false; hideScreen(qs('#gameOverOverlay')); hideScreen(qs('#pauseOverlay')); hideScreen(qs('#waitingOnline'));
    switchSections('#game', '#menu'); removeAllNameTags();
    if (roomUnsub) roomUnsub(); roomUnsub=null;
    if (presenceUnsub) presenceUnsub(); presenceUnsub=null;
  }
  function togglePause(){ paused = !paused; const p = qs('#pauseOverlay'); if (paused) showScreen(p); else hideScreen(p); }
  function restartGame(){ hideScreen(qs('#pauseOverlay')); hideScreen(qs('#gameOverOverlay')); startGame(gameMode); }

  qs('#btnExitGame').addEventListener('click', exitGame);
  qs('#btnPause').addEventListener('click', togglePause);
  qs('#btnResume').addEventListener('click', togglePause);
  qs('#btnBackMenu').addEventListener('click', exitGame);
  qs('#btnRestart').addEventListener('click', restartGame);
  qs('#btnGORestart').addEventListener('click', restartGame);
  qs('#btnGOMenu').addEventListener('click', exitGame);

  // Canvas clicks (debug pickups)
  qs('#canvas').addEventListener('click', (e)=>{ if (Math.random()<0.25) spawnPickup(e.clientX, e.clientY); });

  // Inicial
  fetchIP().then(updateIPText);
  refreshPlayerStateUI();
  showScreen(qs('#menu'));
</script>
</body>
</html>
